---
title: "FantasySim for portfolio"
author: "Harrison Stanton"
date: "2026-02-08"
output: html_document
---

NOTE: If you visited my portfolio and are attempting to run this code, RData and CSV files that are necessary are stored in my GitHub (All_Players_Database.RData, RookieDatabase.RData). You can find a link to that from my portolio website by clicking the GitHub icon.

```{r, message=FALSE}
library(tidyverse)
library(dplyr)
library(rsconnect)
library(kableExtra)
library(nflfastR)
library(nflreadr)
library(stats)
library(Hmisc)
library(readr)
library(scales)
```


```{r, message=FALSE}
load("All_Players_Database.RData")
load("RookieDatabase.RData")
Rookie_database <- Rookie_database %>% arrange(full_name)
```

Excluding 2025 playoffs from projections
```{r}
All_Players_Database <- All_Players_Database %>% filter(!(week > 19 & season == 2025))
Rookie_Database <- Rookie_database %>% filter(!(week > 19 & season == 2025))
```


#Data cleaning
```{r}
Rookie_database <- Rookie_database %>%
  group_by(position, bucket) %>%
  mutate(
    deviation = sd(total_fantasy_points, na.rm = TRUE),
    mean = mean(total_fantasy_points, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  filter(
    is.na(total_fantasy_points) |
    (total_fantasy_points <= mean + 3 * deviation &
     total_fantasy_points >= mean - 3 * deviation &
     total_fantasy_points >= 0)
  )
```


#adding bucket to/pick to ff
```{r}
ff <- All_Players_Database %>% 
  filter(season == "2023" | season == "2025" | season == "2024" | season == "0") %>%
  group_by(player_id) %>%
  arrange(desc(season), desc(week)) %>%
  slice_head(n=16) %>%
  ungroup()
```

```{r}
ff <- ff %>%
  group_by(player_id) %>%
  mutate(
    deviation = sd(total_fantasy_points, na.rm = TRUE),
    mean = mean(total_fantasy_points, na.rm = TRUE)
  ) %>%
  ungroup()
```


```{r}
ff <- ff %>%
  filter((is.rookie == FALSE & total_fantasy_points <= mean + 3 * deviation & total_fantasy_points >= mean - 3 * deviation) | is.rookie == TRUE | is.na(deviation) & !is.na(mean))
```




#Adding bucket to ff
```{r}
temp <- Rookie_database %>%
  distinct(player_id, .keep_all = TRUE) %>%
  select(player_id, bucket)
```


```{r}
ff <- left_join(ff, temp, by = "player_id")
```

To avoid double counting rookie's scores when generating the weighted quantile
```{r}
Rookie_database <- Rookie_database %>%
  filter(season != 2025)
```


```{r}
ff <- ff %>%
  filter(!(player_id == "00-0039890" & season == 2024) | (player_id == "00-0039890" & season == 2025 & week < 8))

ff <- ff %>%
  filter(!(player_id == "00-0039893" & season == 2024))
```


#weighted quantile
```{r}
weighted_quantile <- function(x, w, probs = c(0.25, 0.5, 0.75)) {
  # Remove NAs
  keep <- !is.na(x) & !is.na(w)
  x <- x[keep]
  w <- w[keep]

  # Sort x and w by x
  ord <- order(x)
  x <- x[ord]
  w <- w[ord]

  # Normalize weights
  w <- w / sum(w)
  cum_w <- cumsum(w)

  # Interpolate
  sapply(probs, function(p) {
    if (p <= cum_w[1]) return(x[1])
    if (p >= cum_w[length(cum_w)]) return(x[length(x)])
    idx <- which(cum_w >= p)[1]
    if (cum_w[idx] == p || idx == 1) {
      return(x[idx])
    } else {
      x1 <- x[idx - 1]
      x2 <- x[idx]
      w1 <- cum_w[idx - 1]
      w2 <- cum_w[idx]
      # Linear interpolation
      return(x1 + (p - w1) / (w2 - w1) * (x2 - x1))
    }
  })
}
```





#injured/decreased bumps
Score * 1.42
```{r}
increased_roles <- c(
  #Evan Hull
  "00-0038397"
)
```

score * 1.35
```{r}
mild_increase <- c(
  #Adonai Mitchell
  "00-0039890"
)
```


score * .35
```{r}
decreased_roles <- c(
  #Jacory Croskey-Merritt
  "00-0040242",
  #Noah Fant
  "00-0035644",
  #Tyquan Thornton
  "00-0038104",
  #Jalen McMillan
  "00-0039855",
  #Marvin Mims
  "00-0038976",
  #Matthew Golden
  "00-0040667",
  #Nick Chubb
  #"00-0034791",
  #Ameer Abdullah
  "00-0032104",
  #Gabe Davis
  "00-0036196",
  #Mitchell Tinsley
  "00-0038839",
  #Tez Johnson
  "00-0040237",
  #Brandin Cooks
  "00-0031236",
  #Sterlin Shephard
  "00-0032385",
  #Sean Tucker
  "00-0038951",
  #Jalen Tolbert
  "00-0037666",
  #Kyle Williams
  "00-0040131",
  #Isaiah Bond
  "00-0040782",
  #Kendric Bourne
  "00-0033307",
  #Dyami Brown
  "00-0036626",
  #Will Dissly
  "00-0034159",
  #Dylan Sampson
  #"00-0040162",
  #Audric Estime
  "00-0039373",
  #Jake Tonges
  "00-0037112",
  #Roschon Johnson
  "00-0039021",
  #DeAndre Hopkins
  "00-0030564",
  #Curtis Samuel
  "00-0033282",
  #Nick Westbrook-Ikhine
  "00-0036182",
  #Jordan Whittington
  "00-0039751",
  #Brian Robinson
  "00-0037746",
  #Tank Bigsby
  "00-0038555",
  #Adam Thielen
  "00-0030035", 
  #Jonnu Smith
  "00-0033858",
  #Keaton Mitchell
  #"00-0038454",
  #Malachi Corley
  "00-0039920",
  #Tim Patrick
  "00-0033375",
  #Isaac Guerendo
  "00-0039363",
  #Taysom Hill
  "00-0033357",
  #Noah Gray
  "00-0036637"
  )
```

score * 0
```{r}
bye_week <- ff %>%
  filter(season == 2025) %>%
  filter(posteam %in% c()) %>%
  distinct(player_id, .keep_all = FALSE) %>%
  pull(player_id)
```

score * 0
```{r}
injured <- c(
  #Davante Adams
  "00-0031381",
  #Elijah Arroyo
  "00-0040739",
  #Rashee Rice
  "00-0039067",
  #Devaughn Vele
  "00-0039424",
  #Ricky Pearsall
  "00-0039916",
  #Tyquan Thornton
  "00-0038104",
  #Woody Marks
  "00-0040583",
  #Patrick Mahomes
  "00-0033873",
  #Luther Burden
  "00-0040735",
  #Noah Fant
  "00-0035644",
  #Bhayshul Tuten
  "00-0040719",
  #Devin Neal
  "00-0040202",
  #Rome Odunze
  "00-0039919",
  #Cedric Tillman
  "00-0038979",
  #Hollywood Brown
  "00-0035662",
  #Dylan Sampson
  "00-0040162",
  #Cade Otton
  #"00-0038129",
  #Nick Chubb
  #"00-0034791",
  #Malachi Corley
  #"00-0039920",
  #Mason Taylor
  "00-0040736",
  #Tee Higgins
  #"00-0036410",
  #Pat Bryant
  #"00-0040134",
  #Daniel Jones
  "00-0035710",
  #Jayden Daniels
  "00-0039910",
  #Rome Odunze
  #"00-0039919",
  #Michael Mayer
  "00-0039066",
  #Alvin Kamara
  "00-0033906",
  #Greg Dortch
  "00-0035500",
  #Marvin Harrison
  #"00-0039849",
  #Drake London
  #"00-0037238",
  #Calvin Ridley
  "00-0034837",
  #Isaac Guerendo
  "00-0039363",
  #Michael Penix
  "00-0039917",
  #Deshaun Watson
  "00-0033537",
  #Dillon Gabriel
  "00-0040704",
  #Sam LaPorta
  "00-0039065",
  #Will Dissly
  "00-0034159",
  #Roschon Johnson
  "00-0039021",
  #JK Dobbins
  "00-0036158",
  #Rashod Bateman
  "00-0036550",
  #Justice Hill
  "00-0034975",
  #Hunter Long
  "00-0037004",
  #Luke McCaffrey
  "00-0039355",
  #Tory Horton
  "00-0040648",
  #Tucker Kraft
  "00-0038996",
  #Travis Hunter
  "00-0040718",
  #Cam Skattebo
  "00-0040715",
  #Josh Reynolds
  "00-0033943",
  #Kendre Miller
  "00-0038551",
  #Curtis Samuel
  "00-0033282",
  #Ray-Ray McCloud
  "00-0034407",
  #Garrett Wilson
  "00-0037740",
  #Lucas Krull
  "00-0037539",
  #Antonio Gibson
  "00-0036328",
  #James Conner
  "00-0033553", 
  #Tank Dell
  "00-0038977", 
  #Malik Nabers
  "00-0039337", 
  #Mike Evans
  #"00-0031408",
  #Zach Ertz
  "00-0030061",
  #Brandon Aiyuk
  "00-0036261",
  #Braelon Allen
  "00-0039794",
  #Joe Mixon
  "00-0033897",
  #Tyreek Hill
  "00-0033040",
  #Ja'Lynn Polk
  "00-0039907",
  #Trey Benson
  "00-0039921",
  #MarShawn Lloyd
  "00-0039811",
  #Najee Harris
  "00-0036893",
  #Jonathon Brooks
  "00-0039344"
  #Jalen McMillan
  #"00-0039855"
  )
```

score * 0
```{r}
suspended <- c(
)
```


score * 0
```{r}
backup_qbs <- c(
  #Tua Tagovailoa
  "00-0036212",
  #Kenny Pickett
  "00-0036196",
  #Joe Flacco
  "00-0026158",
  #Davis Mills
  "00-0036898",
  #Kyler Murray
  "00-0035228",
  #Spencer Rattler
  "00-0039376",
  #Justin Fields
  "00-0036945",
  #Anthony Richardson
  "00-0039164",
  #Jalen Milroe
  "00-0040673",
  #Russell Wilson
  "00-0029263",
  #Kirk Cousins
  #"00-0029604",
  #Marcus Mariota
  #"00-0032268",
  #Tyrod Taylor
  "00-0028118",
  #Jake Browning
  "00-0035100",
  #Joe Milton
  "00-0039398",
  #Mason Rudolph
  "00-0034771",
  #Jameis Winston
  "00-0031503",
  #Mac Jones
  "00-0036972",
  #Jacoby Brissett
  #"00-0033119",
  #Carson Wentz
  "00-0032950",
  #Tyler Huntley
  "00-0035993",
  #Cooper Rush
  "00-0033662",
  #Max Brosmer
  "00-0040494"
)
```

score * .85
```{r}
mild_decrease <- c(
  #Deebo Samuel
  "00-0035719",
  #George Pickens
  "00-0037247",
  #Mike Evans
  "00-0031408",
  #Bucky Irving
  "00-0039361",
  #D'Andre Swift
  "00-0036275",
  #Terry McLaurin
  "00-0035659",
  #Shedeur Sanders
  "00-0040668",
  #Dalton Schultz
  "00-0034383",
  #Marvin Harrison
  "00-0039849",
  #Josh Jacobs
  "00-0035700",
  #Drake London
  "00-0037238",
  #Parker Washington
  "00-0038606",
  #Rachaad White
  "00-0037256",
  #Romeo Doubs
  "00-0037816",
  #Dontayvion Wicks
  "00-0038393",
  #Jayden Reed
  "00-0039146",
  #Mike Gesicki
  "00-0034829",
  #Chase Brown
  #"00-0038597",
  #Emeka Egbuka
  "00-0040129",
  #Kimani Vidal
  "00-0039391",
  #Omarion Hampton
  "00-0040666",
  #Quentin Johnston
  "00-0038544",
  #Troy Franklin
  "00-0039868",
  #Geno Smith
  #"00-0030565",
  #Rashid Shaheed
  "00-0037545",
  #Chuba Hubbard
  "00-0036555",
  #Rico Dowdle
  "00-0036139",
  #Jake Ferguson
  "00-0038041",
  #David Montgomery
  "00-0035685",
  #Cole Kmet
  "00-0036290",
  #Rhamondre Stevenson
  "00-0036875",
  #Christian Kirk
  "00-0034775",
  #Breece Hall
  "00-0038120",
  #Jaylin Noel
  "00-0040138",
  #Keaton Mitchell
  "00-0038454",
  #TreVeyon Henderson
  "00-0040734",
  #Tee Higgins
  "00-0036410",
  #Xavier Worthy
  "00-0039894",
  #Luther Burden
  "00-0040735",
  #Tory Horton
  "00-0040648",
  #Colston Loveland
  "00-0040126",
  #DJ Moore
  "00-0034827",
  #Will Shipley
  "00-0039746",
  #Cade Otton
  "00-0038129",
  #Travis Kelce
  "00-0030506",
  #Chris Godwin
  "00-0033921",
  #Pat Freiermuth
  "00-0036894",
  #Juwan Johnson
  "00-0036040",
  #Tommy Tremble
  "00-0037005",
  #Isaiah Likely
  "00-0037838",
  #Alvin Kamara
  "00-0033906"
)
```

score * .9
decrease Vikings due to McCarthy underperforming 2024 Darnold
```{r}
 vikings <- ff %>%
  filter(season == 2025) %>%
  filter(posteam %in% c("MIN")) %>%
  distinct(player_id, .keep_all = FALSE) %>%
  pull(player_id)

vikings <- vikings[!vikings %in% c("00-0039923")]
```

score * .8
decrease Browns due to offense performing worse with Sanders
```{r}
browns <- ff %>%
  filter(season == 2025) %>%
  filter(posteam %in% c("CLE")) %>%
  distinct(player_id, .keep_all = FALSE) %>%
  pull(player_id)

browns <- browns[!browns %in% c("00-0040704", "00-0040668")]
```

score * .8
decrease Colts and Chiefs due to backup QB play
```{r}
colts_chiefs <- ff %>%
  filter(season == 2025) %>%
  filter(posteam %in% c("IND", "KC")) %>%
  distinct(player_id, .keep_all = FALSE) %>%
  pull(player_id)
```


score - 2
```{r}
shift_left <- c(
  #Saquon Barkley
  "00-0034844",
  #Derrick Henry
  "00-0032764",
  #Jahmyr Gibbs
  "00-0039139",
  #Jaxson Dart
  "00-0040691",
  #Wan'Dale Robinson
  "00-0038117",
  #Emanuel Wilson
  "00-0038797",
  #Colston Loveland
  "00-0040126",
  #Marvin Mims
  "00-0038976",
  #Pat Freiermuth
  "00-0036894",
  #Dallas Goedert
  "00-0034351",
  #Drake London
  "00-0037238",
  #Cooper Kupp
  "00-0033908",
  #Josh Allen
  "00-0034857",
  #Tory Horton
  "00-0040648",
  #DJ Moore
  "00-0034827",
  #Xavier Hutchinson
  "00-0038618",
  #Pop Douglas
  "00-0038621",
  #Ladd McConkey
  "00-0039915",
  #Evan Engram
  "00-0033881",
  #Hollywood Brown
  "00-0035662",
  #Isaiah Likely
  "00-0037838",
  #Keenan Allen
  "00-0030279",
  #Jalen Tolbert
  "00-0037666",
  #Jalen Coker
  "00-0039491",
  #Jauan Jennings
  "00-0036259",
  #Darnell Mooney
  "00-0036309"
)
```

score + 2
```{r}
shift_right <- c(
  #Kyle Pitts
  "00-0036970",
  #Jaxon Smith-Njibga
  "00-0038543",
  #Brenton Strange
  "00-0038935",
  #CeeDee Lamb
  "00-0036358",
  #CMC
  "00-0033280",
  #Jaylen Waddle
  "00-0036613",
  #Chris Olave
  "00-0037239"
  ) 
```


#Example fantasy teams
```{r}
Team_Stanton <- c("00-0036389", "00-0039893", "00-0038543", "00-0037809", "00-0036912", "00-0037816", "00-0036264", "00-0040734", "00-0040676", "00-0040126", "00-0037545", "00-0040663", "00-0040648", "00-0038951", "00-0040131", "00-0040138", "00-0039491", "00-0039146", "00-0040719", "00-0038797", "00-0038454", "00-0034383", "00-0032268", "00-0026158")
```


```{r}
Team_Johnson <- c("00-0039732", "00-0036555", "00-0040242", "00-0036322", "00-0039337", "00-0038933", "00-0037740", "00-0039894", "00-0035710", "00-0039376", "00-0039901", "00-0038935", "00-0036139", "00-0040739", "00-0039868", "00-0040729", "00-0040715", "00-0039874", "00-0039923", "00-0038611", "00-0040078", "00-0040218", "00-0035689", "00-0038397", "00-0039912")
```


```{r}
Team_Snyder <- c("00-0034857", "00-0040122", "00-0038134", "00-0035676", "00-0036410", "00-0039338", "00-0039064", "00-0034796", "00-0037228", "00-0036997", "00-0036970", "00-0036626", "00-0040735", "00-0040669", "00-0035644", "00-0039355", "00-0040189", "00-0038994", "00-0032385", "00-0038977", "00-0039384", "00-0039410", "00-0040704", "00-0037252", "00-0031236")
```


```{r}
Team_Kloth <- c("00-0036442", "00-0038542", "00-0038597", "00-0036252", "00-0035229", "00-0039040", "00-0038120", "00-0034855", "00-0030565", "00-0037239", "00-0038996", "00-0030279", "00-0038608", "00-0036875", "00-0037664", "00-0038117", "00-0040170", "00-0038563", "00-0036261", "00-0039424", "00-0038619", "00-0035500", "00-0034829", "00-0037291", "1-R-QB5")
```


```{r}
Team_Weiner <- c("00-0033077", "00-0036158", "00-0036613", "00-0036973", "00-0034869", "00-0037525", "00-0033858", "00-0039794", "00-0040164", "00-0036893", "00-0036358", "00-0038124", "00-0039164", "00-0038705", "00-0039798", "00-0039738", "00-0040583", "00-0036972", "00-0039066", "00-0033881", "00-0037614", "00-0038544", "00-0039398", "00-0039398", "00-0038679")
```


```{r}
Team_Chesney <- c("00-0039163", "00-0034791", "00-0034827", "00-0037240", "00-0036290", "00-0039916", "00-0037247", "00-0038979", "00-0040130", "00-0030564", "00-0039793", "00-0033282",  "00-0037666", "00-0033375", "00-0034407", "00-0037741", "00-0036328", "00-0036182", "00-0033857", "00-0031503", "00-0039920", "00-0033555", "00-0036165")
```


```{r}
Team_Hamm <- c("00-0036355", "00-0040198", "00-0038551", "00-0040667", "00-0039065", "00-0039356", "00-0038621", "00-0036550", "00-0040581", "00-0040644", "00-0040134", "00-0039890", "00-0038104", "00-0039907", "00-0039344", "00-0039855", "00-0040237", "00-0040584", "00-0040705", "00-0037837", "00-0033537", "00-0039907", "1-R-QB5", "2-R-QB5")
```


```{r}
Team_Downing <- c("00-0033873", "00-0033280", "00-0036223", "00-0036900", "00-0033885", "00-0037248", "00-0034348", "00-0039917", "00-0031381", "00-0034837", "00-0037197", "00-0036275", "00-0034753", "00-0040782", "00-0036945", "00-0035659", "00-0028118", "00-0029604", "00-0030506", "00-0036407", "00-0040668", "00-0031610", "00-0035289", "00-0036924", "00-0040590")
```


```{r}
Team_Lindsay <- c("00-0039361", "00-0039915", "00-0034351", "00-0037261", "00-0036894", "00-0039851", "00-0023459", "00-0040718", "00-0039342", "00-0038976", "00-0039921", "00-0040179", "00-0039875", "00-0039880", "00-0039746", "00-0040784", "00-0037238", "00-0039032", "00-0037838", "00-0039910", "00-0037157", "00-0031408", "00-0035250", "00-0038606", "00-0037563")
```


```{r}
Team_Klein_Diel <- c("00-0039150", "00-0039139", "00-0040666", "00-0036554", "00-0040124", "00-0040128", "00-0040129", "00-0039849", "00-0039918", "00-0040730", "00-0040162", "00-0039847", "00-0040142", "00-0040736", "00-0040236", "00-0035662", "00-0040727", "00-0035535", "00-0040691", "00-0039067", "00-0039391", "00-0038558", "00-0033526", "00-0035359")
```


```{r}
Team_Wu <- c("00-0035228", "00-0035261", "00-0039075", "00-0037744", "00-0033040", "00-0036971", "00-0036212", "00-0035719", "00-0035685", "00-0034960", "00-0031588", "00-0037263", "00-0037746", "00-0035700", "00-0038997", "00-0039165", "00-0033553", "00-0033288", "00-0033921", "00-0033897", "00-0040737", "00-0040743", "00-0040202", "00-0038559", "00-0036244")
```


```{r}
Team_McClowry <- c("00-0034844", "00-0032764", "00-0036963", "00-0035640", "00-0038041", "00-0037840", "00-0033106", "00-0036919", "00-0039919", "00-0038129", "00-0036309", "00-0033090", "00-0036040", "00-0037256", "00-0037834", "00-0036259", "00-0033119", "00-0033906", "00-0033923", "00-0033293", "00-0026498", "00-0038393", "00-0035537", "00-0039373", "00-0035208")
```

#Fantasy team roster accuracy checks
See all players on given team
```{r}
ff %>%
  filter(player_id %in% Team_Downing) %>%
  distinct(player_id, .keep_all = TRUE) %>% 
  view()
```

Check for duplicates on given team 
```{r}
duplicates <- Team_McClowry[duplicated(Team_McClowry)]
duplicates
```

#Projection
Function to simulate 20k scores for each player of team_1 and team_2. Returns a Df with player_id, team, observation, projected score, full name, and position. 

ff is the data frame created above containing past 16 games for each player.
```{r}
sim_two <- function(ff, team_1, team_2){
  player_ids_vector <- c()
  all_player_scores_list <- list()
  ff <- ff %>%
    select(season, week, full_name, player_id, season_player_id, full_name, position, total_fantasy_points, is.rookie, GP, bucket) %>%
    arrange(full_name)
  
  
  player_lookup <- ff %>%
    distinct(player_id, .keep_all = TRUE) %>%
    select(player_id, position, full_name)
  
  subset_df <- ff %>%
    filter(player_id %in% c(team_1, team_2)) 
  
  ids <- c(team_1, team_2)
  
  #keeping user created players
  user_created_players <- ids[grepl("WR,|RB,|TE,|QB,", ids)]
  user_created_players <- tibble(raw = user_created_players) %>%
    mutate(
      team = ifelse(raw %in% team_1, "Team 1", "Team 2")
    ) %>%
    extract(raw, into = c("position", "score"),
            regex = "([^,]+), (\\d+(?:\\.\\d+)?) pts",
            convert = TRUE)


  
  #filtering out user created players from ids
  ids <- ids[!grepl("WR,|RB,|TE,|QB,", ids)]
  

  team_1 <- team_1[!grepl("WR,|RB,|TE,|QB,", team_1)]
  team_2 <- team_2[!grepl("WR,|RB,|TE,|QB,", team_2)]
  teams <- c(rep("Team 1", length(team_1)),
           rep("Team 2", length(team_2)))
  
  player_info <- tibble(player_id = ids, team = teams) %>%
    left_join(player_lookup, by = "player_id")
  
  
  n_obs <- 20000
  
  
  full_ids <- rep(player_info$player_id, each = n_obs)
  full_positions <- rep(player_info$position, each = n_obs)
  full_names <- rep(player_info$full_name, each = n_obs)
  full_observations <- rep(1:n_obs, length(ids))
  
  
  for(i in 1:length(ids)){
    #df with only the one player's stats
    player <- subset_df %>%
      filter(player_id == ids[[i]]) %>%
      arrange(desc(season), desc(week))
    
    is_rookie <- player$is.rookie[1]
    gp_max <- max(player$GP)


    
     if(is_rookie && gp_max < 12){
         player_position <- player$position[1]
         player_bucket <- player$bucket[1]

         #scores from the same position and bucket as the rookie we're looking at
         position_bucket_scores <- Rookie_database %>%
         filter(position == player_position & bucket == player_bucket) %>%
         pull(total_fantasy_points)

         #player's individual scores
         player_scores <- player$total_fantasy_points

         #number of individual's scores
         rookie_games <- length(player_scores)
         #number of just bucket player's scores
         bucket_games <- length(position_bucket_scores)


         #This is implementing piecewise function instead to slow down weight of rookie's scores initially
        if(gp_max < 8){
           p <- .8
         } else {
           p <- 0.9
         }
         rookie_weights <- rep(p / rookie_games, rookie_games)
         bucket_weights <- rep((1 - p) / bucket_games, bucket_games)
         combined_weights <- c(rookie_weights, bucket_weights)

         
         player_quantile <- weighted_quantile(
           c(player_scores, position_bucket_scores),
           combined_weights,
           probs = c(.1, .90)
           )

    
     } else {
          player_quantile <- quantile(player$total_fantasy_points, probs = c(.075, .9))
      }
    
      rng <- runif(n_obs)
      scores <- numeric(n_obs)
      
              lower <- unname(player_quantile[1])
              upper <- unname(player_quantile[2])
              scores[rng < .075] <- lower
              scores[rng >= .9] <- upper
              mid_idx <- rng >= .075 & rng < .9
              scores[mid_idx] <- lower + (rng[mid_idx] - 0.075) * (upper - lower) / 0.825

      all_player_scores_list[[i]] <- scores
  } 

  
  
  scores <- tibble(
    observation = full_observations,
    player_id = full_ids,
    team = rep(player_info$team, each = n_obs),
    score = unlist(all_player_scores_list),
    full_name = full_names,
    position = full_positions
  )
  
  scores <- scores %>%
    mutate(
      score = 
        case_when(
          player_id %in% decreased_roles ~ score * .35,
          player_id %in% increased_roles ~ score * 1.42,
          player_id %in% c(backup_qbs, injured, suspended, bye_week) ~ score * 0,
          player_id %in% mild_decrease ~ score * .8,
          player_id %in% mild_increase ~ score * 1.35,
          player_id %in% browns ~ score * .8,
          player_id %in% colts_chiefs ~ score * .8,
          player_id %in% vikings ~ score * .9,
          player_id %in% shift_right ~ score + 2,
          player_id %in% shift_left ~ score - 2,
          TRUE ~ score
        )
    )
        

  scores <- add_score(user_created_players, scores)

  return(scores)
}

```



#add players function, two teams
Function was built as a helper to sim_two(). The intention was to have users of a Shiny App enter player scores that already happened. This would factor those scores into their simulated lineups and give an updated projection.
```{r}
#helper function for sim_two()
#the function returns scores with the user_created_players added on.
add_score <- function(user_created_players, scores) {
  n <- length(user_created_players$score)
  if(n > 0){
    observation <- seq_len(15000)          # stays same size as your original
    fake_id <- as.character(-sample.int(1e9, n))  # one id per row
    
    temp <- tibble(
      player_id = fake_id,
      score     = user_created_players$score,
      team      = user_created_players$team,
      full_name = paste0(user_created_players$position, ", ", user_created_players$score, " pts"),
      position  = user_created_players$position
    )
    
    temp <- cbind(observation, temp)
    scores <- bind_rows(scores, temp)
  }
    return(scores)
}
```



Optimize function returns 20k optimized lineups for each team.
```{r}
optimize_teams <- function(scores) {


  df <- scores %>%
    arrange(observation, desc(score))
  

  df <- df %>%
    group_by(observation, team) %>%
    mutate(
      qb_rank = cumsum(position == "QB"),
      rb_rank = cumsum(position == "RB"),
      wr_rank = cumsum(position == "WR"),
      te_rank = cumsum(position == "TE")
    ) %>%
    ungroup()
  

  starters <- df %>%
    filter(
      (position == "QB" & qb_rank <= 1) |
      (position == "RB" & rb_rank <= 2) |
      (position == "WR" & wr_rank <= 2) |
      (position == "TE" & te_rank <= 1)
    )
  
  picked_ids <- starters %>% select(observation, team, player_id)
  

  flex <- df %>%
    filter(position %in% c("RB", "WR", "TE")) %>%
    anti_join(picked_ids, by = c("observation", "team", "player_id")) %>%
    group_by(observation, team) %>%
    slice_head(n = 2) %>%
    ungroup()
  
  picked_ids <- bind_rows(picked_ids, flex %>% select(observation, team, player_id))
  
  superflex <- df %>%
    anti_join(picked_ids, by = c("observation", "team", "player_id")) %>%
    group_by(observation, team) %>%
    slice_head(n = 1) %>%
    ungroup()
  

  optimized_team <- bind_rows(starters, flex, superflex) %>%
    arrange(observation, team, desc(score)) %>%
    select(observation, player_id, team, score, full_name, position)
  

  obs_totals <- optimized_team %>%
    group_by(observation, team) %>%
    summarise(total = sum(score, na.rm = TRUE), .groups = "drop") %>%
    pivot_wider(names_from = team, values_from = total) %>%
    mutate(
      winner = if_else(`Team 1` > `Team 2`, "Team 1", "Team 2")
    )
  
  return(obs_totals)
}
```



#projection
Code to simulate 20k optimized lineups for Team A vs. Team B matchup
```{r}
optimal <- optimize_teams(sim_two(ff, Team_Stanton, Team_Downing))
```

Code to generate win probability for given matchup
```{r}
optimal %>%
  count(winner) %>%
  mutate(
    winner = factor(winner, levels = c("Team 2", "Team 1")),
    win_prob = round(n / 20000, 2) * 100,
    #this label y is so broken. need to fix this tomorrow.
    label_y = ((20000 - n) + .5 * n)/20000
    ) 
```


Code to generate projected scores for given matchup
```{r}
optimal %>%
  summarise(
    Team_1_score = round(mean(`Team 1`)),
    Team_2_score = round(mean(`Team 2`))
  ) 

```


Code to view individual player projections for Team A and Team B
```{r}
scores <- sim_two(ff, Team_Stanton, Team_Hamm)
```

```{r}
scores %>%
  filter(player_id %in% Team_Stanton) %>%
  group_by(player_id) %>%
  summarise(
    lin_avg = median(score)
  ) %>%
  inner_join(ff %>% select(player_id, full_name) %>% distinct(player_id, .keep_all = TRUE), by = "player_id") %>%
  arrange(full_name) %>%
  view()
```



